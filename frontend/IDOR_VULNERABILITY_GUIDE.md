# IDOR Vulnerability Demonstration Guide

## What is IDOR?

**IDOR** stands for **Insecure Direct Object Reference**. It's a vulnerability where an application allows users to access resources belonging to other users by directly manipulating object identifiers (like IDs, usernames, or file names).

## Vulnerability in This App

### Location: `/api/users/[id]`

The endpoint at `app/api/users/[id]/route.ts` is intentionally vulnerable because:

1. **No Authorization Check**: The API directly returns user data based on the ID parameter without verifying if the authenticated user should have access to that data
2. **Direct Object Reference**: The user ID is directly exposed in the URL and can be easily modified
3. **No Session Validation**: The endpoint doesn't validate that the request comes from an authenticated user

### How to Exploit It

1. Log in with any demo account
2. Go to the "IDOR Vulnerability Test" section on the dashboard
3. Change the User ID field to another ID (1-5)
4. Click "Fetch User"
5. You'll immediately access another user's sensitive information (name, email, phone, address) without authorization

## How to Fix IDOR Vulnerabilities

### 1. Implement Proper Authentication

\`\`\`typescript
// Verify the user is authenticated
const session = await auth()
if (!session) {
  return Response.json({ error: 'Unauthorized' }, { status: 401 })
}
\`\`\`

### 2. Implement Authorization Checks

\`\`\`typescript
// Only return data if the user owns the resource
if (session.userId !== parseInt(id)) {
  return Response.json(
    { error: 'Forbidden - You cannot access this user data' },
    { status: 403 }
  )
}
\`\`\`

### 3. Complete Secure Example

\`\`\`typescript
export async function GET(
  request: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    // 1. Get authenticated user
    const session = await getSession()
    if (!session) {
      return Response.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const { id } = await params
    const requestedUserId = parseInt(id, 10)

    // 2. Check if user is trying to access their own data
    if (session.userId !== requestedUserId) {
      return Response.json(
        { error: 'Forbidden - Cannot access other users data' },
        { status: 403 }
      )
    }

    // 3. Fetch and return the data
    const user = await db.user.findUnique({
      where: { id: requestedUserId },
    })

    if (!user) {
      return Response.json({ error: 'User not found' }, { status: 404 })
    }

    return Response.json({ success: true, user })
  } catch (error) {
    return Response.json(
      { success: false, message: 'Internal server error' },
      { status: 500 }
    )
  }
}
\`\`\`

## Database Schema (PostgreSQL)

\`\`\`sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  full_name VARCHAR(255) NOT NULL,
  username VARCHAR(255) UNIQUE NOT NULL,
  phone VARCHAR(20),
  address TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Sample data
INSERT INTO users (email, password_hash, full_name, username, phone, address) VALUES
('user1@example.com', '$2b$10$...', 'John Doe', 'johndoe', '+1-555-0101', '123 Main St, New York, NY 10001'),
('user2@example.com', '$2b$10$...', 'Jane Smith', 'janesmith', '+1-555-0102', '456 Oak Ave, Los Angeles, CA 90001'),
('user3@example.com', '$2b$10$...', 'Bob Johnson', 'bobjohnson', '+1-555-0103', '789 Pine Rd, Chicago, IL 60601');
\`\`\`

## Key Takeaways

- **Always validate authorization**: Just because a user is authenticated doesn't mean they should access all resources
- **Indirect references**: Use UUIDs instead of sequential IDs when possible
- **Principle of Least Privilege**: Users should only access what they specifically need
- **Server-side validation**: Never trust client-side checks alone
- **Rate limiting**: Limit API requests to prevent automated data scraping

## Resources

- OWASP: https://owasp.org/www-community/attacks/Insecure_Direct_Object_References
- CWE-639: https://cwe.mitre.org/data/definitions/639.html
